- name: DEBIAN | Install GitLab GPG key
  apt_key:
    state: present
    url: https://packages.gitlab.com/gpg.key
  tags:
    - gitlab
    - gitlab-gpg

- name: DEBIAN | Install support packages
  apt:
    name:
      - curl
      - ca-certificates
      - "{{ gitlab_smtp_service }}"
      - apt-transport-https
    state: latest
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - gitlab
    - gitlab-packages

- name: DEBIAN | Install GitLab CE
  apt:
    name: gitlab-ce{{ '=' + gitlab_version + gitlab_version_suffix if gitlab_version is defined else '' }}
    state: "{{ 'present' if gitlab_version is defined else 'latest' }}"
    update_cache: yes
    cache_valid_time: 3600
  notify:
    - reconfigure gitlab
    - restart gitlab
    - wait for unicorn
  tags:
    - gitlab
    - gitlab-update
